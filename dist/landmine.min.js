//landmine.js
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c=a("../utils"),d=function(a){c.requireOptions(a,"canvasSize","fieldSize"),this.statusBarHeight=0,this.statusBar=!!a.statusBar,this.canvasSize=a.canvasSize,this.fieldSize=a.fieldSize,this.locationSize=this.calculateLocationSize(this.canvasSize,this.fieldSize),a.statusBar&&(this.statusBarHeight=this.locationSize)};d.prototype.calculateLocationSize=function(a,b){var c=this.statusBar?b.height+1:b.height;return Math.floor(Math.min(a.width/b.width,a.height/c))},d.prototype.locationToPoint=function(a,b){return{x:a*this.locationSize,y:b*this.locationSize+this.statusBarHeight}},d.prototype.locationToCenterPoint=function(a,b){var c=this.locationToPoint(a,b);return{x:c.x+this.locationSize/2,y:c.y+this.locationSize/2}},d.prototype.locationToScaledOffsetPoint=function(a,b,c,d){var e=this.locationToPoint(a,b);return{x:e.x+c*this.locationSize,y:e.y+d*this.locationSize}},d.prototype.applyScaledOffsetsToCenter=function(a,b,c){return{x:a.x+b*(this.locationSize/2),y:a.y+c*(this.locationSize/2)}},d.prototype.locationRect=function(a,b){var c=this.locationToPoint(a,b);return{x:c.x,y:c.y,width:this.locationSize,height:this.locationSize}},d.prototype.scaleScalar=function(a){return this.locationSize*a},d.prototype.locationFontSize=function(){return this.locationSize},d.prototype.statusBarCenter=function(){return{x:this.fieldSize.width*this.locationSize/2,y:this.statusBarHeight/2}},d.prototype.statusBarFontSize=function(){return this.scaleScalar(.75)},d.prototype.statusBarCorner=function(a){if("topleft"===a)return{x:0,y:0};if("bottomleft"===a)return{x:0,y:this.statusBarHeight};if("topright"===a)return{x:this.fieldSize.width*this.locationSize,y:0};if("bottomright"===a)return{x:this.fieldSize.width*this.locationSize,y:this.statusBarHeight};throw new Error("Unrecognized corner identifier: "+a)},d.prototype.promptRectangle=function(){return{x:.25*this.canvasSize.width,y:.25*this.canvasSize.height,width:.5*this.canvasSize.width,height:.5*this.canvasSize.height}},d.prototype.promptFontSize=function(){return this.statusBarFontSize()},b.exports=d},{"../utils":19}],2:[function(a,b){var c=a("../utils"),d=function(a){c.requireOptions(a,"context","metrics"),this.metrics=a.metrics,this.context=a.context};d.prototype.draw=function(a,b){var c=this.context,d=this.metrics.locationRect(a,b);c.beginPath(),c.rect(d.x,d.y,d.width,d.height),c.lineWidth=1,c.stroke()},b.exports=d},{"../utils":19}],3:[function(a,b){var c=a("../utils"),d=["green","blue","red","fuchsia","teal","purple","olive","navy"],e=function(a){return d[a-1]},f=function(a){return"bold "+a+"px Arial"},g=[{x:.6,y:.2},{x:.3,y:.6},{x:.7,y:.7}],h=[{x:-.13333333333333333,y:-.8666666666666667},{x:.06666666666666667,y:-.3333333333333333},{x:.26666666666666666,y:-.6666666666666666},{x:.26666666666666666,y:-.2},{x:.6666666666666666,y:.26666666666666666},{x:.13333333333333333,y:.06666666666666667},{x:.4666666666666667,y:.7333333333333333},{x:-.13333333333333333,y:.13333333333333333},{x:-.4666666666666667,y:.6},{x:-.4,y:0},{x:-.7333333333333333,y:-.4666666666666667},{x:-.4,y:-.3333333333333333}],i=[{color:"red",x:-.4666666666666667,y:-.7333333333333333,width:.2,height:.2},{color:"black",x:-.06666666666666667,y:-.7333333333333333,width:.06666666666666667,height:.6666666666666666},{color:"black",x:-.4,y:.6,width:.43333333333333335,height:.06666666666666667}],j=function(a){c.requireOptions(a,"context","metrics","field"),this.context=a.context,this.field=a.field,this.metrics=a.metrics};j.prototype.draw=function(a,b,c){if(a.detonated)return void this._drawStar(b,c);if(a.flagged)return void this._drawFlag(b,c);if(a.dug){var d=this.field.countMines(b,c);d>0&&this._drawCount(b,c,d)}else this._drawDirt(b,c)},j.prototype._drawDirt=function(a,b){var c=this;g.forEach(function(d){c._drawDirtBox(a,b,d)})},j.prototype._drawDirtBox=function(a,b,c){var d=this.metrics.locationToScaledOffsetPoint(a,b,c.x,c.y),e=this.metrics.scaleScalar(.1),f=this.context;f.beginPath(),f.rect(d.x,d.y,e,e),f.fillStyle="black",f.fill()},j.prototype._drawCount=function(a,b,c){var d=this.metrics.locationToCenterPoint(a,b),g=this.context;g.fillStyle=e(c),g.font=f(this.metrics.locationFontSize()),g.textAlign="center",g.textBaseline="middle",g.fillText(c,d.x,d.y)},j.prototype._drawStar=function(a,b){var c=this.context,d=this.metrics.locationToCenterPoint(a,b);c.beginPath();var e=this._starOffsetToPoint(d,0);c.moveTo(e.x,e.y);for(var f=1;f<h.length;f++)e=this._starOffsetToPoint(d,f),c.lineTo(e.x,e.y);c.closePath(),c.fillStyle="yellow",c.fill(),c.stroke(),c.beginPath();var g=this.metrics.scaleScalar(.05);c.arc(d.x,d.y,g,0,2*Math.PI,!1),c.fillStyle="red",c.fill(),c.stroke()},j.prototype._starOffsetToPoint=function(a,b){var c=h[b];return this.metrics.applyScaledOffsetsToCenter(a,c.x,c.y)},j.prototype._drawFlag=function(a,b){var c=this.metrics.locationToCenterPoint(a,b),d=this;i.forEach(function(a){var b=d.metrics.applyScaledOffsetsToCenter(c,a.x,a.y),e=d.metrics.scaleScalar(a.width),f=d.metrics.scaleScalar(a.height);d._fillRect(a.color,b.x,b.y,e,f)})},j.prototype._fillRect=function(a,b,c,d,e){var f=this.context;f.beginPath(),f.rect(b,c,d,e),f.fillStyle=a,f.fill()},b.exports=j},{"../utils":19}],4:[function(a,b){var c=a("./fieldlocationartist"),d=a("./cursorartist"),e=a("./canvasmetrics"),f=a("./statusbarartist"),g=a("../utils"),h=function(a){g.requireOptions(a,"game","canvas"),this.game=a.game;var b=a.canvas;this.context=b.getContext("2d"),this.canvasSize={width:b.width,height:b.height},this.metrics=new e({canvasSize:this.canvasSize,fieldSize:this.game.field,statusBar:!0}),this.locationArtist=new c({metrics:this.metrics,context:this.context,field:this.game.field}),this.cursorArtist=new d({context:this.context,metrics:this.metrics}),this.statusBarArtist=new f({context:this.context,metrics:this.metrics});var h=this;this.game.on("invalidated",function(){h.draw()})};h.prototype.draw=function(){var a=this,b=this.game;this.clear(),this.game.field.forEach(function(b,c,d){a.locationArtist.draw(b,c,d)}),this.statusBarArtist.draw({timeRemaining:b.score.timeBonusRemaining(),minesRemaining:b.level.minesRemaining(),score:b.score.current(),level:b.level.levelNumber}),"pre-game"===this.game.state||"between-levels"===this.game.state?this._drawStartPrompt():this.cursorArtist.draw(b.cursor.x,b.cursor.y)},h.prototype.clear=function(){this.context.clearRect(0,0,this.canvasSize.width,this.canvasSize.height)},h.prototype._drawStartPrompt=function(){this._drawPrompt("Press Enter to Start")},h.prototype._drawPrompt=function(a){var b=this.metrics.promptRectangle(),c=this.context;c.clearRect(b.x,b.y,b.width,b.height),c.beginPath(),c.rect(b.x,b.y,b.width,b.height),c.stroke();var d=this.metrics.promptFontSize(),e=g.rectangleCenter(b.x,b.y,b.width,b.height);c.font=""+d+"px Arial",c.textBaseline="middle",c.textAlign="center",c.fillText(a,e.x,e.y)},b.exports=h},{"../utils":19,"./canvasmetrics":1,"./cursorartist":2,"./fieldlocationartist":3,"./statusbarartist":5}],5:[function(a,b){var c=a("../utils"),d=function(a){c.requireOptions(a,"metrics","context"),this.metrics=a.metrics,this.context=a.context};d.prototype.draw=function(a){var b=this.context;b.fillStyle="black","undefined"!=typeof a.timeRemaining&&this._drawTimeRemaining(a.timeRemaining),"undefined"!=typeof a.score&&this._drawScore(a.score),"undefined"!=typeof a.minesRemaining&&this._drawMinesRemaining(a.minesRemaining),"undefined"!=typeof a.level&&this._drawLevel(a.level)},d.prototype._drawTimeRemaining=function(a){var b=this.metrics.statusBarCorner("topleft"),c=this.context;c.font=this.font(),c.textAlign="left",c.textBaseline="top",c.fillText("Time: "+a,b.x,b.y)},d.prototype._drawMinesRemaining=function(a){var b=this.metrics.statusBarCorner("bottomleft"),c=this.context;c.font=this.font(),c.textAlign="left",c.textBaseline="bottom",c.fillText("Mines: "+a,b.x,b.y)},d.prototype._drawLevel=function(a){var b=this.metrics.statusBarCorner("topright"),c=this.context;c.font=this.font(),c.textAlign="right",c.textBaseline="top",c.fillText("Level: "+a,b.x,b.y)},d.prototype._drawScore=function(a){var b=this.context,c=this.metrics.statusBarCenter();b.font=this.scoreFont(),b.textAlign="center",b.textBaseline="middle",b.fillText(a,c.x,c.y)},d.prototype.scoreFont=function(){var a=this.metrics.statusBarFontSize();return""+a+"px Arial"},d.prototype.font=function(){var a=.5*this.metrics.statusBarFontSize();return""+a+"px Arial"},b.exports=d},{"../utils":19}],6:[function(a,b){var c=function(a,b,c){this.x=a,this.y=b,this.field=c};c.prototype.moveLeft=function(){this.tryMoveDelta(-1,0)},c.prototype.moveRight=function(){this.tryMoveDelta(1,0)},c.prototype.moveUp=function(){this.tryMoveDelta(0,-1)},c.prototype.moveDown=function(){this.tryMoveDelta(0,1)},c.prototype.tryMoveDelta=function(a,b){this.field.isInRange(this.x+a,this.y+b)&&(this.x+=a,this.y+=b)},b.exports=c},{}],7:[function(a,b){var c=a("./eventhandler"),d={37:"move:left",38:"move:up",39:"move:right",40:"move:down",16:"dig",90:"flag",13:"confirm"},e=function(a){this.handlers={};var b=this;a.setAttribute("tabindex","1"),a.focus(),a.addEventListener("keydown",function(a){"undefined"!=typeof d[a.keyCode]&&(b.fire(d[a.keyCode]),b.fire("any",d[a.keyCode]))})};c.extend(e),b.exports=e},{"./eventhandler":8}],8:[function(a,b){var c={},d=function(a){return a.__events__||(a.__events__={}),a.__events__},e=function(a,b){var c=d(a);return c[b]||(c[b]=[])};c.extend=function(a){a.prototype.on=function(a,b){var c=e(this,a);c.push(b)},a.prototype.fire=function(a){var b=Array.prototype.slice.call(arguments,1),c=e(this,a);c.forEach(function(a){a.apply(null,b)})}},b.exports=c},{}],9:[function(a,b){var c=a("./utils"),d=function(a){c.requireOptions(a,"eventDispatcher"),this.eventDispatcher=a.eventDispatcher,this.events=[];var b=this;this.eventDispatcher.on("any",function(a){b.events.push({event:a,time:(new Date).getTime()})})};b.exports=d},{"./utils":19}],10:[function(a){var b=a("./game"),c=a("./artists/gameartist"),d=a("./eventdispatcher"),e=a("./utils"),f=a("./eventlogger"),g=a("./playbackdispatcher"),h=window.Landmine||{};h.start=function(a){e.requireOptions(a,"canvas");var g=a.eventDispatcher||new d(a.canvas),i=new b({canvas:a.canvas,eventDispatcher:g}),j=(new c({canvas:a.canvas,game:i}),new f({eventDispatcher:g}));return h.events=j,i.start(),i},h.playback=function(a){e.requireOptions(a,"canvas","events");var b=new g({events:a.events});a.eventDispatcher=b,h.start(a),b.start()},window.Landmine=h},{"./artists/gameartist":4,"./eventdispatcher":7,"./eventlogger":9,"./game":12,"./playbackdispatcher":16,"./utils":19}],11:[function(a,b){var c=function(){this.hasMine=!1,this.dug=!1,this.flagged=!1,this.detonated=!1};c.prototype.dig=function(){if(this.hasMine)throw new Error("exploded");if(!this.flagged)return this.dug?!1:(this.dug=!0,!0)},c.prototype.flag=function(){this.dug||(this.flagged=!this.flagged)},c.prototype.placeMine=function(){this.hasMine=!0},c.prototype.detonate=function(){this.hasMine&&(this.detonated=!0)},c.prototype.reset=function(){this.hasMine=!1,this.flagged=!1,this.dug=!1,this.detonated=!1},b.exports=c},{}],12:[function(a,b){var c=a("./utils"),d=a("./minefield"),e=a("./cursor"),f=a("./level"),g=a("./eventhandler"),h=a("./score"),i=function(a){c.requireOptions(a,"eventDispatcher"),this.field=new d({width:14,height:10}),this.cursor=new e(0,0,this.field),this.level=new f({game:this}),this.score=a.scorer||new h(this),this.state="pre-game",this.bindEvents(a.eventDispatcher)};g.extend(i),i.prototype.start=function(){this.fire("started"),this.fire("invalidated"),this.state="pre-game",this.cursor.x=0,this.cursor.y=0},i.prototype.canPlay=function(){return"between-levels"!==this.state&&"pre-game"!==this.state&&"detonated"!==this.state},i.prototype.startLevel=function(){this.state="playing",this.cursor.x=0,this.cursor.y=0,this.fire("level:started"),this.fire("invalidated")},i.prototype.bindEvents=function(a){var b=this;a.on("confirm",function(){"pre-game"===b.state?b.startLevel():"between-levels"===b.state?(b.level.moveNext(),b.startLevel()):"detonated"===b.state&&(b.level.reset(),b.start())}),a.on("move:left",function(){b.canPlay()&&(b.cursor.moveLeft(),b.fire("invalidated"))}),a.on("move:right",function(){b.canPlay()&&(b.cursor.moveRight(),b.fire("invalidated"))}),a.on("move:up",function(){b.canPlay()&&(b.cursor.moveUp(),b.fire("invalidated"))}),a.on("move:down",function(){b.canPlay()&&(b.cursor.moveDown(),b.fire("invalidated"))}),a.on("dig",function(){if(b.canPlay()){var a=b.field.get(b.cursor.x,b.cursor.y);a.flagged||(a.hasMine?(b.field.detonateMines(),b.fire("detonated"),b.state="detonated",b.fire("gameOver",{score:b.score.current()})):a.dig()&&b.fire("dig:safe"),b.level.finished()&&(b.field.flagAllMines(),b.state="between-levels",b.fire("level:finished")),b.fire("invalidated"))}}),a.on("flag",function(){if(b.canPlay()){var a=b.field.get(b.cursor.x,b.cursor.y);a.dug||(a.flag(),b.fire(a.flagged?"flag:added":"flag:removed"),b.fire("invalidated"))}})},b.exports=i},{"./cursor":6,"./eventhandler":8,"./level":13,"./minefield":14,"./score":17,"./utils":19}],13:[function(a,b){var c=a("./mineplacer"),d=a("./utils"),e=function(a){d.requireOptions(a,"game");var b=a.game;this.field=b.field,this.reset();var c=this;b.on("dig:safe",function(){c.dig()}),b.on("flag:added",function(){c.flag()}),b.on("flag:removed",function(){c.unflag()})};e.prototype.mines=function(){return 4*this.levelNumber},e.prototype.minesRemaining=function(){return this.mines()-this.flags},e.prototype.flag=function(){this.flags++},e.prototype.unflag=function(){this.flags--},e.prototype.dig=function(){this.spacesCleared++},e.prototype.spacesRemaining=function(){return this.field.width*this.field.height-this.spacesCleared-this.mines()},e.prototype.finished=function(){return 0===this.spacesRemaining()},e.prototype.reset=function(){this.levelNumber=1,this.levelReset()},e.prototype.moveNext=function(){this.levelNumber++,this.levelReset()},e.prototype.levelReset=function(){this.spacesCleared=0,this.flags=0,this.setMines()},e.prototype.setMines=function(){this.field.reset();var a=new c;a.placeMines(this.field,this.mines())},b.exports=e},{"./mineplacer":15,"./utils":19}],14:[function(a,b){var c=a("./utils").extend,d=a("./fieldlocation"),e=function(a){"undefined"==typeof a&&(a={});var b={width:80,height:40};this.options=c(b,a),this.width=this.options.width,this.height=this.options.height,this.field=new Array(this.width);for(var e=0;e<this.width;e++){this.field[e]=new Array(this.height);for(var f=0;f<this.height;f++)this.field[e][f]=new d}};e.prototype.get=function(a,b){if(!this.isInRange(a,b))throw new Error("position out of range ("+a+", "+b+")");return this.field[a][b]};var f=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:-1},{x:0,y:1},{x:1,y:-1},{x:1,y:0},{x:1,y:1}];e.prototype.getNeighbors=function(a,b){for(var c=[],d=0,e=f.length;e>d;d++){var g=f[d],h=a+g.x,i=b+g.y;this.isInRange(h,i)&&c.push(this.get(h,i))}return c},e.prototype.isInRange=function(a,b){return a>=0&&a<this.width&&b>=0&&b<this.height},e.prototype.countMines=function(a,b){for(var c=this.getNeighbors(a,b),d=0,e=c.length-1;e>=0;e--)c[e].hasMine&&d++;return d},e.prototype.forEach=function(a){var b=0,c=0,d=this.width,e=this.height;for(b=0;d>b;b++)for(c=0;e>c;c++)a(this.get(b,c),b,c)},e.prototype.countAllMines=function(){var a=this;this.forEach(function(b,c,d){b.count=a.countMines(c,d)})},e.prototype.detonateMines=function(){this.forEach(function(a){a.detonate()})},e.prototype.flagAllMines=function(){this.forEach(function(a){a.hasMine&&!a.flagged&&a.flag()})},e.prototype.reset=function(){this.forEach(function(a){a.reset()})},b.exports=e},{"./fieldlocation":11,"./utils":19}],15:[function(a,b){var c=function(){};c.prototype.placeMines=function(a,b){if(b>this.totalPlacableMines(a))throw new Error("Can't place "+b+" mines in a field sized "+a.width+"x"+a.height);for(var c=0;b>c;c++)this.placeMine(a)},c.prototype.placeMine=function(a){var b,c,d=!1;do c=this.randomLocation(a),b=a.get(c.x,c.y),b.hasMine||(b.placeMine(),d=!0);while(!d)},c.prototype.randomLocation=function(a){return{x:Math.floor(Math.random()*(a.width-1))+1,y:Math.floor(Math.random()*a.height)}},c.prototype.totalPlacableMines=function(a){return(a.width-1)*a.height},b.exports=c},{}],16:[function(a,b){var c=a("./utils"),d=a("./eventhandler"),e=function(a){c.requireOptions(a,"events"),this.events=a.events,this.current=0};d.extend(e);var f=function(){var a=this,b=a.events,c=a.current;console.log("playing back",b[c].event),a.fire(b[c].event),b[c+1]&&(setTimeout(f.bind(a),b[c+1].time-b[c].time),a.current++)};e.prototype.start=function(){setTimeout(f.bind(this),0)},b.exports=e},{"./eventhandler":8,"./utils":19}],17:[function(a,b){var c=a("./timer"),d=function(a){this.score=0,this.timeEllapsed=0,this.timer=new c(1e3),this.timer.on("tick",function(c){b.timeEllapsed+=c,a.fire("invalidated")});var b=this;a.on("dig:safe",function(){b.score++}),a.on("level:finished",function(){b.score+=b.timeBonusRemaining(),b.timer.stop()}),a.on("level:started",function(){b.resetLevel(),b.timer.start()}),a.on("detonated",function(){b.timer.stop()}),a.on("started",function(){b.resetGame()})};d.prototype.current=function(){return this.score},d.prototype.timeBonusRemaining=function(){return 180-this._secondsEllapsed()},d.prototype._secondsEllapsed=function(){return Math.floor(this.timeEllapsed/1e3)},d.prototype.resetLevel=function(){this.timeEllapsed=0},d.prototype.resetGame=function(){this.timeEllapsed=0,this.score=0},b.exports=d},{"./timer":18}],18:[function(a,b){var c=function(a){this.interval=a,this.eventHandlers={},this.lastTick=0};c.prototype.on=function(a,b){var c=this.eventHandlers[a]||(this.eventHandlers[a]=[]);c.push(b)},c.prototype.fire=function(a){var b=Array.prototype.slice.call(arguments,1);this.eventHandlers[a]&&this.eventHandlers[a].forEach(function(a){a.apply(null,b)})},c.prototype.start=function(){if(this._intervalId)throw new Error("Timer already started!");var a=this;this.lastTick=Date.now(),this._intervalId=setInterval(function(){a.fire("tick",Date.now()-a.lastTick),a.lastTick=Date.now()},this.interval)},c.prototype.stop=function(){clearInterval(this._intervalId),this._intervalId=null},b.exports=c},{}],19:[function(a,b){var c=function(){var a,b,c={},d=0,e=arguments.length;for(d=0;e>d;d++){b=arguments[d];for(a in b)void 0!==b[a]&&(c[a]=b[a])}return c},d=function(a){var b=Array.prototype.slice.call(arguments,1);b.forEach(function(b){if("undefined"==typeof a[b])throw new Error(b+" is a required option")})},e=function(a,b,c,d){return{x:a+c/2,y:b+d/2}},f=function(a,b,c){return e(a,b,c,c)};b.exports={extend:c,requireOptions:d,squareCenter:f,rectangleCenter:e}},{}]},{},[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]);